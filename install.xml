<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright 2017-present, Facebook, Inc. -->
<!-- All rights reserved. -->

<!-- This source code is licensed under the license found in the -->
<!-- LICENSE file in the root directory of this source tree. -->

<!-- system auto generated, DO NOT MODIFY. -->
<modification>
	<name>Facebook Business Extension</name>
	<code>facebook_business_extension</code>
	<version>3.1.1</version>
	<author>Facebook</author>
	<link>https://github.com/facebookincubator/Facebook-For-OpenCart</link>

  <!-- Admin panel settings -->
  <file path="admin/controller/common/column_left.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $token = (isset($this->session->data['user_token']))
          ? $this->session->data['user_token']
          : $this->session->data['token'];
        $tokenString = 'token=' . $token . '&user_token=' . $token;
        $facebookBusinessExtension = array();
        $facebookBusinessExtension[] = array(
          'name'     => 'Facebook Business Extension',
          'href'     => $this->url->link('extension/facebookadsextension', $tokenString, true),
          'children' => array()
        );

        $data['menus'][] = array(
          'id'       => 'menu-facebook-business-extension',
          'icon'     => 'fa-facebook-square',
          'name'     => 'Facebook Business Extension',
          'href'     => '',
          'children' => $facebookBusinessExtension
        );
      ]]></add>
    </operation>
  </file>

  <!-- Admin dashboard settings -->
  <file path="admin/controller/common/dashboard.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $this->load->language('common/dashboard');
        try {
          $operation = ', dashboard module';

          // validates the plugin
          if (!is_file(DIR_APPLICATION . '/controller/extension/facebookadsextension.php')) {
            throw new Exception($this->language->get(
              'text_warning_facebook_missing_facebookadsextension'));
          }
          $all_error_messages = $this->load->controller(
            'extension/facebookadsextension/validate');
          if (sizeof($all_error_messages) > 0) {
            throw new Exception($this->language->get(
              'text_warning_facebook_fae_install_problem'));
          }

          $this->load->controller(
            'extension/facebookproduct/validateFAEAndCatalogSetup',
            $operation);

          $hasNewUpgradeAvailable = $this->load->controller(
            'extension/facebookadsextension/hasNewUpgradeAvailable',
            $operation);
          $data['plugin_upgrade_message'] = ($hasNewUpgradeAvailable)
            ? FacebookCommonUtils::PLUGIN_UPGRADE_MESSAGE
            : '';

          $showFeedMigratedAndWebsiteInMaintenanceWarningMessage = $this->load->controller(
            'extension/facebookadsextension/isFeedMigratedAndWebsiteInMaintenance'
          );
          $data['plugin_feed_migrated_and_website_in_maintenance_message'] =
            $showFeedMigratedAndWebsiteInMaintenanceWarningMessage
            ? $this->language->get('text_warning_plugin_feed_migrated_and_website_in_maintenance_message')
            : '';

        } catch (Exception $e) {
          $data['error_facebook_sync'] =
            ($e->getCode() === FacebookGraphAPIError::ACCESS_TOKEN_EXCEPTION_CODE)
            ? $this->language->get('text_warning_facebook_access_token_problem')
            : $e->getMessage();
        }
      ]]></add>
    </operation>
  </file>

  <file path="admin/view/template/common/dashboard.tpl">
    <operation>
      <search><![CDATA[<?php if ($error_install) { ?>]]></search>
      <add position="before"><![CDATA[
        <?php if (isset($error_facebook_sync) && !!($error_facebook_sync)) {?>
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> <?php echo $error_facebook_sync; ?>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        <?php } ?>
        <?php if (isset($plugin_upgrade_message) && !!($plugin_upgrade_message)) {?>
        <div class="alert alert-info"><i class="fa fa-exclamation-circle"></i> <?php echo $plugin_upgrade_message; ?>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        <?php } ?>
        <?php if (isset($plugin_feed_migrated_and_website_in_maintenance_message) && !!($plugin_feed_migrated_and_website_in_maintenance_message)) {?>
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> <?php echo $plugin_feed_migrated_and_website_in_maintenance_message; ?>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        <?php } ?>
      ]]></add>
    </operation>
  </file>

  <!-- For opencart v2.x and not v2.3.x, -->
  <!-- the method of displaying the functions on menu sidebar of admin panel -->
  <!-- is via explicit hardcoding on the menu controller and template -->
  <!-- This code insertion is to handle for v2.x and not v2.3.x -->
  <!-- by explicitly adding FAE to menu controller and template -->
  <!-- In v2.3.x, there are no menu.php and menu.tpl files -->

  <!-- Seach syntax for opencart v2.2.0.0 and below -->
  <file path="admin/controller/common/menu.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $token = (isset($this->session->data['user_token']))
          ? $this->session->data['user_token']
          : $this->session->data['token'];
        $tokenString = 'token=' . $token . '&user_token=' . $token;
        $data['text_facebook_ads_extension'] = 'Facebook Business Extension';
        $data['facebookadsextension'] = $this->url->link('extension/facebookadsextension', $tokenString, 'SSL');
      ]]></add>
    </operation>
  </file>

  <file path="admin/view/template/common/menu.tpl">
    <operation>
      <search><![CDATA[<ul id="menu">]]></search>
      <add position="after"><![CDATA[
        <li id="facebookadsextension"><a class="parent"><i class="fa fa-facebook-square fa-fw"></i> <span><?php echo $text_facebook_ads_extension; ?></span></a>
          <ul>
            <li>
              <a href="<?php echo $facebookadsextension; ?>">
                <?php echo $text_facebook_ads_extension; ?>
              </a>
            </li>
          </ul>
        </li>
      ]]></add>
    </operation>
  </file>

  <!-- Firing the pixel init and event code -->
  <!-- The facebook_pixel_event_params_FAE is retrieved from the request->post -->
  <file path="catalog/controller/common/header.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $data['facebook_pixel_id_FAE'] =
          $this->fbevents['facebook_pixel_id_FAE'];
        $data['facebook_pixel_pii_FAE'] =
          $this->fbevents['facebook_pixel_pii_FAE'];
        $data['facebook_pixel_params_FAE'] =
          $this->fbevents['facebook_pixel_params_FAE'];
        $data['facebook_pixel_params_FAE'] =
          $this->fbevents['facebook_pixel_params_FAE'];
        $data['facebook_pixel_event_params_FAE'] =
          $this->fbevents['facebook_pixel_event_params_FAE'];
        $data['facebook_enable_cookie_bar'] =
          $this->fbevents['facebook_enable_cookie_bar'];

        // remove away the facebook_pixel_event_params_FAE in session data
        // to avoid duplicate firing after the 1st fire
        unset($this->session->data['facebook_pixel_event_params_FAE']);

        // pull in the cookie bar settings from the language bar
        $this->load->language('common/header');
        $data['cookie_bar_header_value'] =
          json_encode($this->language->get('cookie_bar_header_value'));
        $data['cookie_bar_description_value'] =
          json_encode($this->language->get('cookie_bar_description_value'));
        $data['cookie_bar_opt_in_value'] =
          json_encode($this->language->get('cookie_bar_opt_in_value'));
        $data['cookie_bar_opt_out_value'] =
          json_encode($this->language->get('cookie_bar_opt_out_value'));
      ]]></add>
    </operation>
  </file>

  <!-- Showing up the customer chat plugin -->
  <!-- The customer chat plugin options are retrieved from the settings -->
  <file path="catalog/controller/common/header.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $data['facebook_page_id_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_PAGE_ID);
        $data['facebook_jssdk_version_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_JSSDK_VER);
        $data['facebook_messenger_enabled_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_MESSENGER);
        // default locale to en_US if setting is not available
        $customization_locale = $this->config->get(
          FacebookCommonUtils::FACEBOOK_CUSTOMIZATION_LOCALE);
        $data['facebook_customization_locale_FAE'] =
          ($customization_locale)
          ? $customization_locale
          : 'en_US';
      ]]></add>
    </operation>
  </file>

  <!-- The actual firing of the pixel code is done in the header file -->
  <!-- The injection for the header file is based on locating -->
  <!-- the tag </head> which should give the lowest chance to break -->
  <!-- with custom plugins -->
  <file path="catalog/view/theme/*/template/common/header.tpl">
    <operation>
      <search><![CDATA[</head>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // we are using this flag to determine if the pixel
          // is successfully added to the header
          window.isFacebookPixelInHeaderAdded = 1;
          window.isFacebookPixelAdded=1;
        </script>

        <script type="text/javascript">
          function facebook_loadScript(url, callback) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            if(script.readyState) {  // only required for IE <9
              script.onreadystatechange = function() {
                if (script.readyState === "loaded" || script.readyState === "complete") {
                  script.onreadystatechange = null;
                  if (callback) {
                    callback();
                  }
                }
              };
            } else {  //Others
              if (callback) {
                script.onload = callback;
              }
            }

            script.src = url;
            document.getElementsByTagName("head")[0].appendChild(script);
          }
        </script>

        <script type="text/javascript">
          (function() {
            var enableCookieBar = '<?php echo $facebook_enable_cookie_bar ?>';
            if (enableCookieBar === 'true') {
              facebook_loadScript("catalog/view/javascript/facebook/cookieconsent.min.js");

              // loading the css file
              var css = document.createElement("link");
              css.setAttribute("rel", "stylesheet");
              css.setAttribute("type", "text/css");
              css.setAttribute(
                "href",
                "catalog/view/theme/css/facebook/cookieconsent.min.css");
              document.getElementsByTagName("head")[0].appendChild(css);

              window.addEventListener("load", function(){
                function setConsent() {
                  fbq(
                    'consent',
                    this.hasConsented() ? 'grant' : 'revoke'
                  );
                }
                window.cookieconsent.initialise({
                  palette: {
                    popup: {
                      background: '#237afc'
                    },
                    button: {
                      background: '#fff',
                      text: '#237afc'
                    }
                  },
                  cookie: {
                    name: fbq.consentCookieName
                  },
                  type: 'opt-out',
                  showLink: false,
                  content: {
                    allow: <?php echo $cookie_bar_opt_in_value ?>,
                    deny: <?php echo $cookie_bar_opt_out_value ?>,
                    header: <?php echo $cookie_bar_header_value ?>,
                    message: <?php echo $cookie_bar_description_value ?>
                  },
                  layout: 'basic-header',
                  location: true,
                  revokable: true,
                  onInitialise: setConsent,
                  onStatusChange: setConsent,
                  onRevokeChoice: setConsent
                }, function (popup) {
                  // If this isn't open, we know that we can use cookies.
                  if (!popup.getStatus() && !popup.options.enabled) {
                    popup.setStatus(cookieconsent.status.dismiss);
                  }
                });
              });
            }
          })();
        </script>

        <script type="text/javascript">
          (function() {
            !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
            n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
            n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');

            var enableCookieBar = '<?php echo $facebook_enable_cookie_bar ?>';
            if (enableCookieBar === 'true') {
              fbq.consentCookieName = 'fb_cookieconsent_status';

              (function() {
                function getCookie(t){var i=("; "+document.cookie).split("; "+t+"=");if(2==i.length)return i.pop().split(";").shift()}
                var consentValue = getCookie(fbq.consentCookieName);
                fbq('consent', consentValue === 'dismiss' ? 'grant' : 'revoke');
              })();
            }

            <?php if ($facebook_pixel_id_FAE) { ?>
// system auto generated facebook_pixel.js, DO NOT MODIFY
pixel_script_filename = 'catalog/view/javascript/facebook/facebook_pixel_3_1_1.js';
// system auto generated facebook_pixel.js, DO NOT MODIFY
              facebook_loadScript(
                pixel_script_filename,
                function() {
                  var params = <?php echo $facebook_pixel_params_FAE ?>;
                  _facebookAdsExtension.facebookPixel.init(
                    '<?php echo $facebook_pixel_id_FAE ?>',
                    <?php echo $facebook_pixel_pii_FAE ?>,
                    params);
                  <?php if ($facebook_pixel_event_params_FAE) { ?>
                    _facebookAdsExtension.facebookPixel.firePixel(
                      JSON.parse('<?php echo $facebook_pixel_event_params_FAE ?>'));
                  <?php } ?>
                });
            <?php } ?>
          })();
        </script>
      ]]></add>
    </operation>
  </file>

  <!-- Insert Messenger customer chat -->
  <!-- We need to insert this before a </div> otherwise the chat will not work -->
  <!-- Selecting the </header> as there could have other divs -->
  <file path="catalog/view/theme/*/template/common/header.tpl">
    <operation>
      <search><![CDATA[</header>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // we are using this flag to determine if the customer chat
          // is successfully added to the header
          window.isFacebookCustomerChatInHeaderAdded = 1;
          window.isFacebookCustomerChatAdded=1;
        </script>

        <?php if ($facebook_messenger_enabled_FAE == 'true') { ?>
        <!-- Facebook JSSDK -->
        <script>
          window.fbAsyncInit = function() {
            FB.init({
              appId            : '',
              autoLogAppEvents : true,
              xfbml            : true,
              version          : '<?php echo $facebook_jssdk_version_FAE ?>'
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "https://connect.facebook.net/<?php echo $facebook_customization_locale_FAE ?>/sdk/xfbml.customerchat.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
        <div
          id="fb-customerchat-header"
          class="fb-customerchat"
          attribution="fbe_opencart"
          page_id="<?php echo $facebook_page_id_FAE ?>"
        />
        <?php } ?>
      ]]></add>
    </operation>
  </file>

  <!-- AddToCart at product details page -->
  <!-- Uses jQuery to add new listener to button-cart.click -->
  <!-- The code injection is set to match <?php echo $footer; ?> -->
  <!-- which will reduce the chance of breakage with custom plugins -->
  <file path="catalog/view/theme/*/template/product/product.tpl">
    <operation>
      <search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before"><![CDATA[
        <input type="hidden" id="fbProductID" value="<?php echo $product_id ?>" />
      ]]></add>
    </operation>
  </file>

  <!-- The actual firing of the pixel code is done in the header file -->
  <!-- The injection for the header file is based on locating -->
  <!-- the tag </head> which should give the lowest chance to break -->
  <!-- with custom plugins -->
  <file path="catalog/view/theme/*/template/common/header.twig">
    <operation>
      <search><![CDATA[</head>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // we are using this flag to determine if the pixel
          // is successfully added to the header
          window.isFacebookPixelInHeaderAdded = 1;
          window.isFacebookPixelAdded=1;
        </script>

        <script type="text/javascript">
          function facebook_loadScript(url, callback) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            if(script.readyState) {  // only required for IE <9
              script.onreadystatechange = function() {
                if (script.readyState === "loaded" || script.readyState === "complete") {
                  script.onreadystatechange = null;
                  if (callback) {
                    callback();
                  }
                }
              };
            } else {  //Others
              if (callback) {
                script.onload = callback;
              }
            }

            script.src = url;
            document.getElementsByTagName("head")[0].appendChild(script);
          }
        </script>

        <script type="text/javascript">
          (function() {
            var enableCookieBar = '{{ facebook_enable_cookie_bar }}';
            if (enableCookieBar === 'true') {
              facebook_loadScript("catalog/view/javascript/facebook/cookieconsent.min.js");

              // loading the css file
              var css = document.createElement("link");
              css.setAttribute("rel", "stylesheet");
              css.setAttribute("type", "text/css");
              css.setAttribute(
                "href",
                "catalog/view/theme/css/facebook/cookieconsent.min.css");
              document.getElementsByTagName("head")[0].appendChild(css);

              window.addEventListener("load", function(){
                function setConsent() {
                  fbq(
                    'consent',
                    this.hasConsented() ? 'grant' : 'revoke'
                  );
                }
                window.cookieconsent.initialise({
                  palette: {
                    popup: {
                      background: '#237afc'
                    },
                    button: {
                      background: '#fff',
                      text: '#237afc'
                    }
                  },
                  cookie: {
                    name: fbq.consentCookieName
                  },
                  type: 'opt-out',
                  showLink: false,
                  content: {
                    allow: {{ cookie_bar_opt_in_value }},
                    deny: {{ cookie_bar_opt_out_value }},
                    header: {{ cookie_bar_header_value }},
                    message: {{ cookie_bar_description_value }}
                  },
                  layout: 'basic-header',
                  location: true,
                  revokable: true,
                  onInitialise: setConsent,
                  onStatusChange: setConsent,
                  onRevokeChoice: setConsent
                }, function (popup) {
                  // If this isn't open, we know that we can use cookies.
                  if (!popup.getStatus() && !popup.options.enabled) {
                    popup.setStatus(cookieconsent.status.dismiss);
                  }
                });
              });
            }
          })();
        </script>

        <script type="text/javascript">
          (function() {
            !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
            n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
            n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');

            var enableCookieBar = '{{ facebook_enable_cookie_bar }}';
            if (enableCookieBar === 'true') {
              fbq.consentCookieName = 'fb_cookieconsent_status';

              (function() {
                function getCookie(t){var i=("; "+document.cookie).split("; "+t+"=");if(2==i.length)return i.pop().split(";").shift()}
                var consentValue = getCookie(fbq.consentCookieName);
                fbq('consent', consentValue === 'dismiss' ? 'grant' : 'revoke');
              })();
            }

            {% if facebook_pixel_id_FAE %}
// system auto generated facebook_pixel.js, DO NOT MODIFY
pixel_script_filename = 'catalog/view/javascript/facebook/facebook_pixel_3_1_1.js';
// system auto generated facebook_pixel.js, DO NOT MODIFY
              facebook_loadScript(
                pixel_script_filename,
                function() {
                  var params = {{ facebook_pixel_params_FAE }};
                  _facebookAdsExtension.facebookPixel.init(
                    '{{ facebook_pixel_id_FAE }}',
                    {{ facebook_pixel_pii_FAE }},
                    params);
                  {% if facebook_pixel_event_params_FAE %}
                    _facebookAdsExtension.facebookPixel.firePixel(
                      JSON.parse('{{facebook_pixel_event_params_FAE }}'));
                  {% endif %}
                });
            {% endif %}
          })();
        </script>
      ]]></add>
    </operation>
  </file>

  <!-- Insert Messenger customer chat -->
  <!-- We need to insert this before a </div> otherwise the chat will not work -->
  <!-- Selecting the </header> as there are divs in a header -->
  <file path="catalog/view/theme/*/template/common/header.twig">
    <operation>
      <search><![CDATA[</header>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // we are using this flag to determine if the customer chat
          // is successfully added to the header
          window.isFacebookCustomerChatInHeaderAdded = 1;
          window.isFacebookCustomerChatAdded=1;
        </script>

        {% if facebook_messenger_enabled_FAE == 'true' %}
        <!-- Facebook JSSDK -->
        <script>
          window.fbAsyncInit = function() {
            FB.init({
              appId            : '',
              autoLogAppEvents : true,
              xfbml            : true,
              version          : '{{ facebook_jssdk_version_FAE }}'
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "https://connect.facebook.net/{{ facebook_customization_locale_FAE }}/sdk/xfbml.customerchat.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
        <div
          id="fb-customerchat-header"
          class="fb-customerchat"
          attribution="fbe_opencart"
          page_id="{{ facebook_page_id_FAE }}"
        />
        {% endif %}
      ]]></add>
    </operation>
  </file>

  <!-- AddToCart at product details page -->
  <!-- Uses jQuery to add new listener to button-cart.click -->
  <!-- The code injection is set to match <?php echo $footer; ?> -->
  <!-- which will reduce the chance of breakage with custom plugins -->
  <file path="catalog/view/theme/*/template/product/product.twig">
    <operation>
      <search><![CDATA[{{ footer }}]]></search>
      <add position="before"><![CDATA[
        <input type="hidden" id="fbProductID" value="{{ product_id }}" />
      ]]></add>
    </operation>
  </file>

  <file path="admin/view/template/common/dashboard.twig">
    <operation>
      <search><![CDATA[<div class="container-fluid">{% if error_install %}]]></search>
      <add position="before"><![CDATA[
        {% if error_facebook_sync %}
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_facebook_sync }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
        {% if plugin_upgrade_message %}
        <div class="alert alert-info"><i class="fa fa-exclamation-circle"></i> {{ plugin_upgrade_message }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
        {% if plugin_feed_migrated_and_website_in_maintenance_message %}
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ plugin_feed_migrated_and_website_in_maintenance_message }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
      ]]></add>
    </operation>
  </file>

  <file path="admin/language/*/common/dashboard.php">
    <operation>
      <search><![CDATA[<?php]]></search>
      <add position="after"><![CDATA[
        $_['text_warning_facebook_sync']           = 'Warning: Encountered problem updating product(s) to Facebook. Please retry again. Check the error log file for more details';
        $_['text_warning_facebook_delete']           = 'Warning: Encountered problem deleting product(s) to Facebook. Check the error log file for more details.';
        $_['text_warning_facebook_access_token_problem'] = 'Warning: There is a problem with your Facebook access token. Please go to Facebook Business Extension to refresh the access token.';
        $_['text_warning_facebook_fae_install_problem'] = 'Warning: There is a problem with your Facebook Business Extension installation. Please go to Facebook Business Extension to view more details.';
        $_['text_warning_facebook_missing_facebookadsextension'] = 'Warning: There is a problem with your Facebook Business Extension installation. We are unable to locate the admin/controller/extension/facebookadsextension.php file on your webserver. Please ensure that you have given read+write+execute permission to the admin/controller folder and reinstall the plugin again. Click <a href="https://github.com/facebookincubator/Facebook-For-OpenCart/blob/master/INSTALL_GUIDE.md" target="_blank">here</a> for details on the plugin installation.';
        $_['text_warning_plugin_feed_migrated_and_website_in_maintenance_message'] = 'Warning: We have detected that your web store is in maintenance mode. This will cause the Facebook catalog scheduled sync to fail. To disable the maintenance mode, access Settings, click on your Store, select Server tab and choose No for Maintenance mode.';
      ]]></add>
    </operation>
  </file>

  <file path="system/engine/router.php">
    <operation>
      <!-- helper method to run actions required for Facebook plugin -->
      <search><![CDATA[public function __construct($registry]]></search>
      <add position="before"><![CDATA[
        private function runAction($actionName) {
          // added in defensive checks to ensure the
          // controller class is available and accessible
          try {
            if (is_file(
              DIR_APPLICATION . '/controller/' . $actionName . '.php')) {
              $facebookAction = new Action($actionName);
              $facebookAction->execute($this->registry);
            }
          } catch (Exception $e) {
            error_log($e->getMessage());
          }
        }
      ]]></add>
    </operation>
  </file>

  <!-- start; this is to cater for OpenCart v3.x  -->
  <file path="system/engine/router.php">  
    <operation>
      <search><![CDATA[while ($action instanceof Action) {]]></search>
      <add position="before"><![CDATA[
        // redirecting the direct checkout URL to product details page
        $this->runAction('extension/facebookpageshopcheckoutredirect');

        // building up the information for pixel firing
        $this->runAction('extension/facebookeventparameters');
      ]]></add>
    </operation>
  </file>

  <file path="system/engine/router.php">
    <operation>
      <search><![CDATA[public function dispatch(Action $action, Action $error) {]]></search>
      <add position="after"><![CDATA[
        // tracking the last pre_action in the list
        $lastPreAction = end($this->pre_action);
      ]]></add>
    </operation>
  </file>
  <!-- end; this is to cater for OpenCart v3.x  -->
  
  <!-- start; this is to cater for OpenCart v3.x but using Journal theme which uses Opencart v2.x coding convention -->
  <file path="system/engine/router.php">  
    <operation>
      <search><![CDATA[while ($action) {]]></search>
      <add position="before"><![CDATA[
        // redirecting the direct checkout URL to product details page
        $this->runAction('extension/facebookpageshopcheckoutredirect');

        // building up the information for pixel firing
        $this->runAction('extension/facebookeventparameters');
      ]]></add>
    </operation>
  </file>

  <file path="system/engine/router.php">
    <operation>
      <search><![CDATA[public function dispatch($action, $error) {]]></search>
      <add position="after"><![CDATA[
        // tracking the last pre_action in the list
        $lastPreAction = end($this->pre_action);
      ]]></add>
    </operation>
  </file>
  <!-- end; this is to cater for OpenCart v3.x but using Journal theme which uses Opencart v2.x coding convention -->

  <!-- start; common for all OpenCart -->
  <file path="system/engine/router.php">
    <operation>
      <search><![CDATA[$result = $this->execute($pre_action);]]></search>
      <add position="after"><![CDATA[
        // additional attempt to extract the pixel details after
        // executing the last preaction on the list of pre-actions
        // we have to wait for all the preactions to be executed as 
        // only then all the required information will be ready, eg
        // uri mapping, shopping cart
        if (isset($lastPreAction) && $pre_action == $lastPreAction) {
          $this->runAction('extension/facebookeventparameters');
        }
      ]]></add>
    </operation>
  </file>
  <!-- end; common for all OpenCart -->


  <file path="system/engine/front.php">
    <operation>
      <!-- helper method to run actions required for Facebook plugin -->
      <search><![CDATA[public function __construct($registry]]></search>
      <add position="before"><![CDATA[
        private function runAction($actionName) {
          // added in defensive checks to ensure the
          // controller class is available and accessible
          try {
            if (is_file(
              DIR_APPLICATION . '/controller/' . $actionName . '.php')) {
              $facebookAction = new Action($actionName);
              $facebookAction->execute($this->registry);
            }
          } catch (Exception $e) {
            error_log($e->getMessage());
          }
        }
      ]]></add>
    </operation>
  </file>

  <!-- start; this is to cater for OpenCart v2.2.0.0 to v2.3.0.2 -->
  <file path="system/engine/front.php">
    <operation>
      <search><![CDATA[while ($action instanceof Action) {]]></search>
      <add position="before"><![CDATA[
        // redirecting the direct checkout URL to product details page
        $this->runAction('extension/facebookpageshopcheckoutredirect');

        // building up the information for pixel firing
        $this->runAction('extension/facebookeventparameters');
      ]]></add>
    </operation>
  </file>

  <!-- additional attempt to extract the pixel details after executing the last preaction on the list of pre-actions -->
  <file path="system/engine/front.php">
    <operation>
      <search><![CDATA[public function dispatch(Action $action, Action $error) {]]></search>
      <add position="after"><![CDATA[
        // tracking the last pre_action in the list
        $lastPreAction = end($this->pre_action);
      ]]></add>
    </operation>
  </file>
  <!-- end; this is to cater for OpenCart v2.2.0.0 to v2.3.0.2 -->

  <!-- start; this is to cater for OpenCart v2.0.3.1 to v2.1.0.2  -->
  <file path="system/engine/front.php">
    <operation>
      <search><![CDATA[while ($action) {]]></search>
      <add position="before"><![CDATA[
        // redirecting the direct checkout URL to product details page
        $this->runAction('extension/facebookpageshopcheckoutredirect');

        // building up the information for pixel firing
        $this->runAction('extension/facebookeventparameters');
      ]]></add>
    </operation>
  </file>

  <!-- additional attempt to extract the pixel details after executing the last preaction on the list of pre-actions -->
  <file path="system/engine/front.php">
    <operation>
      <search><![CDATA[public function dispatch($action, $error) {]]></search>
      <add position="after"><![CDATA[
        // tracking the last pre_action in the list
        $lastPreAction = end($this->pre_action);
      ]]></add>
    </operation>
  </file>
  <!-- end; this is to cater for OpenCart v2.0.3.1 to v2.1.0.2  -->

  <!-- start; common for all OpenCart v2.x  -->
  <file path="system/engine/front.php">
    <operation>
      <search><![CDATA[$result = $this->execute($pre_action);]]></search>
      <add position="after"><![CDATA[
        // additional attempt to extract the pixel details after
        // executing the last preaction on the list of pre-actions
        // we have to wait for all the preactions to be executed as 
        // only then all the required information will be ready, eg
        // uri mapping, shopping cart
        if (isset($lastPreAction) && $pre_action == $lastPreAction) {
          $this->runAction('extension/facebookeventparameters');
        }
      ]]></add>
    </operation>
  </file>
  <!-- end; common for all OpenCart v2.x  -->

  <file path="catalog/language/*/common/header.php">
    <operation>
      <search><![CDATA[<?php]]></search>
      <add position="after"><![CDATA[
        $_['cookie_bar_description_value']       = 'By clicking Agree, you agree to our <a class="cc-link" href="https://www.facebook.com/legal/terms/update" target="_blank">terms of service</a>, <a class="cc-link" href="https://www.facebook.com/policies/" target="_blank">privacy policy</a> and <a class="cc-link" href="https://www.facebook.com/policies/cookies/" target="_blank">cookies policy</a>.';
        $_['cookie_bar_opt_in_value']            = 'Agree';
        $_['cookie_bar_opt_out_value']           = 'Opt Out';
        $_['cookie_bar_header_value']            = 'Our Site Uses Cookies';
      ]]></add>
    </operation>
  </file>

  <!-- Firing the pixel init and event code -->
  <!-- The facebook_pixel_event_params_FAE is retrieved from the request->post -->
  <file path="catalog/controller/common/footer.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $data['facebook_pixel_id_FAE'] =
          $this->fbevents['facebook_pixel_id_FAE'];
        $data['facebook_pixel_pii_FAE'] =
          $this->fbevents['facebook_pixel_pii_FAE'];
        $data['facebook_pixel_params_FAE'] =
          $this->fbevents['facebook_pixel_params_FAE'];
        $data['facebook_pixel_params_FAE'] =
          $this->fbevents['facebook_pixel_params_FAE'];
        $data['facebook_pixel_event_params_FAE'] =
          $this->fbevents['facebook_pixel_event_params_FAE'];
        $data['facebook_enable_cookie_bar'] =
          $this->fbevents['facebook_enable_cookie_bar'];

        // remove away the facebook_pixel_event_params_FAE in session data
        // to avoid duplicate firing after the 1st fire
        unset($this->session->data['facebook_pixel_event_params_FAE']);

        // pull in the cookie bar settings from the language bar
        $this->load->language('common/header');
        $data['cookie_bar_header_value'] =
          json_encode($this->language->get('cookie_bar_header_value'));
        $data['cookie_bar_description_value'] =
          json_encode($this->language->get('cookie_bar_description_value'));
        $data['cookie_bar_opt_in_value'] =
          json_encode($this->language->get('cookie_bar_opt_in_value'));
        $data['cookie_bar_opt_out_value'] =
          json_encode($this->language->get('cookie_bar_opt_out_value'));
      ]]></add>
    </operation>
  </file>

  <!-- Showing up the customer chat plugin -->
  <!-- The customer chat plugin options are retrieved from the settings -->
  <file path="catalog/controller/common/footer.php">
    <operation>
      <search><![CDATA[public function index(]]></search>
      <add position="after"><![CDATA[
        $data['facebook_page_id_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_PAGE_ID);
        $data['facebook_jssdk_version_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_JSSDK_VER);
        $data['facebook_messenger_enabled_FAE'] =
          $this->config->get(FacebookCommonUtils::FACEBOOK_MESSENGER);
        // default locale to en_US if setting is not available
        $customization_locale = $this->config->get(
          FacebookCommonUtils::FACEBOOK_CUSTOMIZATION_LOCALE);
        $data['facebook_customization_locale_FAE'] =
          ($customization_locale)
          ? $customization_locale
          : 'en_US';
      ]]></add>
    </operation>
  </file>

  <!-- Attempt to insert the pixel and messenger chat codes in footer -->
  <!-- if the codes are not inserted in the header -->
  <file path="catalog/view/theme/*/template/common/footer.tpl">
    <operation>
      <search><![CDATA[</footer>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            function facebook_loadScript(url, callback) {
              var script = document.createElement("script");
              script.type = "text/javascript";
              if(script.readyState) {  // only required for IE <9
                script.onreadystatechange = function() {
                  if (script.readyState === "loaded" || script.readyState === "complete") {
                    script.onreadystatechange = null;
                    if (callback) {
                      callback();
                    }
                  }
                };
              } else {  //Others
                if (callback) {
                  script.onload = callback;
                }
              }

              script.src = url;
              document.getElementsByTagName("head")[0].appendChild(script);
            }
          }
        </script>

        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            (function() {
              var enableCookieBar = '<?php echo $facebook_enable_cookie_bar ?>';
              if (enableCookieBar === 'true') {
                facebook_loadScript("catalog/view/javascript/facebook/cookieconsent.min.js");

                // loading the css file
                var css = document.createElement("link");
                css.setAttribute("rel", "stylesheet");
                css.setAttribute("type", "text/css");
                css.setAttribute(
                  "href",
                  "catalog/view/theme/css/facebook/cookieconsent.min.css");
                document.getElementsByTagName("head")[0].appendChild(css);

                window.addEventListener("load", function(){
                  function setConsent() {
                    fbq(
                      'consent',
                      this.hasConsented() ? 'grant' : 'revoke'
                    );
                  }
                  window.cookieconsent.initialise({
                    palette: {
                      popup: {
                        background: '#237afc'
                      },
                      button: {
                        background: '#fff',
                        text: '#237afc'
                      }
                    },
                    cookie: {
                      name: fbq.consentCookieName
                    },
                    type: 'opt-out',
                    showLink: false,
                    content: {
                      allow: <?php echo $cookie_bar_opt_in_value ?>,
                      deny: <?php echo $cookie_bar_opt_out_value ?>,
                      header: <?php echo $cookie_bar_header_value ?>,
                      message: <?php echo $cookie_bar_description_value ?>
                    },
                    layout: 'basic-header',
                    location: true,
                    revokable: true,
                    onInitialise: setConsent,
                    onStatusChange: setConsent,
                    onRevokeChoice: setConsent
                  }, function (popup) {
                    // If this isn't open, we know that we can use cookies.
                    if (!popup.getStatus() && !popup.options.enabled) {
                      popup.setStatus(cookieconsent.status.dismiss);
                    }
                  });
                });
              }
            })();
          }
        </script>

        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            (function() {
              !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
              n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
              n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
              t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
              document,'script','https://connect.facebook.net/en_US/fbevents.js');

              var enableCookieBar = '<?php echo $facebook_enable_cookie_bar ?>';
              if (enableCookieBar === 'true') {
                fbq.consentCookieName = 'fb_cookieconsent_status';

                (function() {
                  function getCookie(t){var i=("; "+document.cookie).split("; "+t+"=");if(2==i.length)return i.pop().split(";").shift()}
                  var consentValue = getCookie(fbq.consentCookieName);
                  fbq('consent', consentValue === 'dismiss' ? 'grant' : 'revoke');
                })();
              }

              <?php if ($facebook_pixel_id_FAE) { ?>
// system auto generated facebook_pixel.js, DO NOT MODIFY
pixel_script_filename = 'catalog/view/javascript/facebook/facebook_pixel_3_1_1.js';
// system auto generated facebook_pixel.js, DO NOT MODIFY
                facebook_loadScript(
                  pixel_script_filename,
                  function() {
                    var params = <?php echo $facebook_pixel_params_FAE ?>;
                    _facebookAdsExtension.facebookPixel.init(
                      '<?php echo $facebook_pixel_id_FAE ?>',
                      <?php echo $facebook_pixel_pii_FAE ?>,
                      params);
                    <?php if ($facebook_pixel_event_params_FAE) { ?>
                      _facebookAdsExtension.facebookPixel.firePixel(
                        JSON.parse('<?php echo $facebook_pixel_event_params_FAE ?>'));
                    <?php } ?>
                  });
              <?php } ?>
            })();
          }
          window.isFacebookPixelAdded=1;
        </script>

        <?php if ($facebook_messenger_enabled_FAE == 'true') { ?>
        <!-- Facebook JSSDK -->
        <script>
          // checks if the customer chat in header is successfully added
          // and if not, will try to add in the messenger chat code to the footer
          if (typeof window.isFacebookCustomerChatInHeaderAdded === 'undefined') {
            window.fbAsyncInit = function() {
              FB.init({
                appId            : '',
                autoLogAppEvents : true,
                xfbml            : true,
                version          : '<?php echo $facebook_jssdk_version_FAE ?>'
              });
            };

            (function(d, s, id){
               var js, fjs = d.getElementsByTagName(s)[0];
               if (d.getElementById(id)) {return;}
               js = d.createElement(s); js.id = id;
               js.src = "https://connect.facebook.net/<?php echo $facebook_customization_locale_FAE ?>/sdk/xfbml.customerchat.js";
               fjs.parentNode.insertBefore(js, fjs);
             }(document, 'script', 'facebook-jssdk'));
          }
          window.isFacebookCustomerChatAdded=1;
        </script>
        <div
          id="fb-customerchat-footer"
          class="fb-customerchat"
          attribution="fbe_opencart"
          page_id="<?php echo $facebook_page_id_FAE ?>"
        />
        <?php } ?>
      ]]></add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/common/footer.tpl">
    <operation>
      <search><![CDATA[</footer>]]></search>
      <add position="after"><![CDATA[
        <?php if ($facebook_messenger_enabled_FAE == 'true') { ?>
        <script>
          // checks if the customer chat in header is successfully added
          // and if so, will need to remove away the customer chat from the footer
          if (window.isFacebookCustomerChatInHeaderAdded === 1) {
            $('div#fb-customerchat-footer').remove();
          }
        </script>
        <?php } ?>
      ]]></add>
    </operation>
  </file>

  <!-- Attempt to insert the pixel and messenger chat codes in footer -->
  <!-- if the codes are not inserted in the header -->
  <file path="catalog/view/theme/*/template/common/footer.twig">
    <operation>
      <search><![CDATA[</footer>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            function facebook_loadScript(url, callback) {
              var script = document.createElement("script");
              script.type = "text/javascript";
              if(script.readyState) {  // only required for IE <9
                script.onreadystatechange = function() {
                  if (script.readyState === "loaded" || script.readyState === "complete") {
                    script.onreadystatechange = null;
                    if (callback) {
                      callback();
                    }
                  }
                };
              } else {  //Others
                if (callback) {
                  script.onload = callback;
                }
              }

              script.src = url;
              document.getElementsByTagName("head")[0].appendChild(script);
            }
          }
        </script>

        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            (function() {
              var enableCookieBar = '{{ facebook_enable_cookie_bar }}';
              if (enableCookieBar === 'true') {
                facebook_loadScript("catalog/view/javascript/facebook/cookieconsent.min.js");

                // loading the css file
                var css = document.createElement("link");
                css.setAttribute("rel", "stylesheet");
                css.setAttribute("type", "text/css");
                css.setAttribute(
                  "href",
                  "catalog/view/theme/css/facebook/cookieconsent.min.css");
                document.getElementsByTagName("head")[0].appendChild(css);

                window.addEventListener("load", function(){
                  function setConsent() {
                    fbq(
                      'consent',
                      this.hasConsented() ? 'grant' : 'revoke'
                    );
                  }
                  window.cookieconsent.initialise({
                    palette: {
                      popup: {
                        background: '#237afc'
                      },
                      button: {
                        background: '#fff',
                        text: '#237afc'
                      }
                    },
                    cookie: {
                      name: fbq.consentCookieName
                    },
                    type: 'opt-out',
                    showLink: false,
                    content: {
                      allow: {{ cookie_bar_opt_in_value }},
                      deny: {{ cookie_bar_opt_out_value }},
                      header: {{ cookie_bar_header_value }},
                      message: {{ cookie_bar_description_value }}
                    },
                    layout: 'basic-header',
                    location: true,
                    revokable: true,
                    onInitialise: setConsent,
                    onStatusChange: setConsent,
                    onRevokeChoice: setConsent
                  }, function (popup) {
                    // If this isn't open, we know that we can use cookies.
                    if (!popup.getStatus() && !popup.options.enabled) {
                      popup.setStatus(cookieconsent.status.dismiss);
                    }
                  });
                });
              }
            })();
          }
        </script>

        <script type="text/javascript">
          // checks if the facebook code in header is successfully added
          // and if not, will try to add in the pixel code to the footer
          if (typeof window.isFacebookPixelInHeaderAdded === 'undefined') {
            (function() {
              !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
              n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
              n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
              t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
              document,'script','https://connect.facebook.net/en_US/fbevents.js');

              var enableCookieBar = '{{ facebook_enable_cookie_bar }}';
              if (enableCookieBar === 'true') {
                fbq.consentCookieName = 'fb_cookieconsent_status';

                (function() {
                  function getCookie(t){var i=("; "+document.cookie).split("; "+t+"=");if(2==i.length)return i.pop().split(";").shift()}
                  var consentValue = getCookie(fbq.consentCookieName);
                  fbq('consent', consentValue === 'dismiss' ? 'grant' : 'revoke');
                })();
              }

              {% if facebook_pixel_id_FAE %}
// system auto generated facebook_pixel.js, DO NOT MODIFY
pixel_script_filename = 'catalog/view/javascript/facebook/facebook_pixel_3_1_1.js';
// system auto generated facebook_pixel.js, DO NOT MODIFY
                facebook_loadScript(
                  pixel_script_filename,
                  function() {
                    var params = {{ facebook_pixel_params_FAE }};
                    _facebookAdsExtension.facebookPixel.init(
                      '{{ facebook_pixel_id_FAE }}',
                      {{ facebook_pixel_pii_FAE }},
                      params);
                    {% if facebook_pixel_event_params_FAE %}
                      _facebookAdsExtension.facebookPixel.firePixel(
                        JSON.parse('{{facebook_pixel_event_params_FAE }}'));
                    {% endif %}
                  });
              {% endif %}
            })();
          }
          window.isFacebookPixelAdded=1;
        </script>

        {% if facebook_messenger_enabled_FAE == 'true' %}
        <!-- Facebook JSSDK -->
        <script>
          // checks if the customer chat in header is successfully added
          // and if not, will try to add in the messenger chat code to the footer
          if (typeof window.isFacebookCustomerChatInHeaderAdded === 'undefined') {
            window.fbAsyncInit = function() {
              FB.init({
                appId            : '',
                autoLogAppEvents : true,
                xfbml            : true,
                version          : '{{ facebook_jssdk_version_FAE }}'
              });
            };

            (function(d, s, id){
               var js, fjs = d.getElementsByTagName(s)[0];
               if (d.getElementById(id)) {return;}
               js = d.createElement(s); js.id = id;
               js.src = "https://connect.facebook.net/{{ facebook_customization_locale_FAE }}/sdk/xfbml.customerchat.js";
               fjs.parentNode.insertBefore(js, fjs);
             }(document, 'script', 'facebook-jssdk'));
          }
          window.isFacebookCustomerChatAdded=1;
        </script>
        <div
          id="fb-customerchat-footer"
          class="fb-customerchat"
          attribution="fbe_opencart"
          page_id="{{ facebook_page_id_FAE }}"
        />
        {% endif %}
      ]]></add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/common/footer.twig">
    <operation>
      <search><![CDATA[</footer>]]></search>
      <add position="after"><![CDATA[
        {% if facebook_messenger_enabled_FAE == 'true' %}
        <script>
          // checks if the customer chat in header is successfully added
          // and if so, will need to remove away the customer chat from the footer
          if (window.isFacebookCustomerChatInHeaderAdded === 1) {
            $('div#fb-customerchat-footer').remove();
          }
        </script>
        {% endif %}
      ]]></add>
    </operation>
  </file>
</modification>
